import os
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px
from src.explanation.shap_integration import plot_local_waterfall

# Set reports folders
PROJECT_ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), "../../"))
REPORTS_DIR = os.path.join(PROJECT_ROOT, "reports")
EXPLAINABILITY_DIR = os.path.join(REPORTS_DIR, "explainability")
os.makedirs(REPORTS_DIR, exist_ok=True)
os.makedirs(EXPLAINABILITY_DIR, exist_ok=True)


def plot_fraud_score_distribution(df, save=True):
    plt.figure(figsize=(8, 5))
    sns.histplot(df["fraud_score"], bins=20, kde=True, color="red")
    plt.title("Fraud Score Distribution")
    plt.xlabel("Fraud Score")
    plt.ylabel("Frequency")
    if save:
        path = os.path.join(REPORTS_DIR, "fraud_score_distribution.png")
        plt.savefig(path, bbox_inches="tight")
        print(f"Saved fraud score distribution plot: {path}")
    plt.close()


def plot_rule_based_factors(df, save=True):
    factor_counts = df["rule_based_factors"].value_counts()
    plt.figure(figsize=(10, 6))
    sns.barplot(x=factor_counts.values, y=factor_counts.index, palette="viridis")
    plt.title("Rule-Based Factor Counts")
    plt.xlabel("Number of Transactions")
    plt.ylabel("Factors")
    if save:
        path = os.path.join(REPORTS_DIR, "rule_based_factors.png")
        plt.savefig(path, bbox_inches="tight")
        print(f"Saved rule-based factors plot: {path}")
    plt.close()


def plot_top_features_plotly(df, shap_top_n=5, save=True):
    shap_cols = [c for c in df.columns if "top_feature_value_" in c]
    if not shap_cols:
        print("No SHAP features found in dataset.")
        return
    feature_sums = {}
    for i in range(1, shap_top_n + 1):
        for idx, row in df.iterrows():
            feature = row.get(f"top_feature_{i}")
            value = row.get(f"top_feature_value_{i}", 0)
            if feature:
                feature_sums[feature] = feature_sums.get(feature, 0) + abs(value)
    top_features_df = pd.DataFrame(feature_sums.items(), columns=["Feature", "Importance"])\
        .sort_values(by="Importance", ascending=False).head(shap_top_n)
    fig = px.bar(top_features_df, x="Importance", y="Feature", orientation="h",
                 title="Top SHAP Feature Contributions", text="Importance")
    if save:
        path = os.path.join(REPORTS_DIR, "top_shap_features.html")
        fig.write_html(path)
        print(f"Saved top SHAP features interactive plot: {path}")


def save_local_shap_waterfall(shap_values, transaction_index=0, save=True):
    if save:
        path = os.path.join(EXPLAINABILITY_DIR, f"waterfall_transaction_{transaction_index}.png")
        plot_local_waterfall(shap_values, transaction_index)
        plt.savefig(path, bbox_inches="tight")
        plt.close()
        print(f"Saved SHAP waterfall plot: {path}")


def generate_example_explanation_cards(df, n=5, save=True):
    sample_df = df.sample(n=min(n, len(df)))
    if not save:
        return
    for idx, row in sample_df.iterrows():
        path = os.path.join(REPORTS_DIR, f"explanation_card_{row['transaction_id']}.txt")
        with open(path, "w") as f:
            f.write(f"Transaction ID: {row['transaction_id']}\n")
            f.write(f"Fraud Score: {row['fraud_score']}\n")
            f.write(f"Fraud Prediction: {row['fraud_prediction']}\n")
            f.write(f"Rule-Based Factors: {row['rule_based_factors']}\n")
            f.write(f"Explanation: {row['explanation']}\n")
        print(f"Saved explanation card: {path}")


def main(df, shap_values=None, generate_reports=True):
    if not generate_reports:
        print("Report generation skipped (generate_reports=False).")
        return
    print("Generating reports...")
    plot_fraud_score_distribution(df)
    plot_rule_based_factors(df)
    plot_top_features_plotly(df)
    if shap_values is not None:
        save_local_shap_waterfall(shap_values, transaction_index=0)
    generate_example_explanation_cards(df, n=5)
    print("All Task 6 reports saved in 'reports/' folder.")


if __name__ == "__main__":
    from src.data_loader.load_fraud_output import load_and_validate_fraud_output

    csv_path = "data/raw/fraud_model_output.csv"
    df_final = load_and_validate_fraud_output(csv_path)

    shap_values = True

    main(df_final, shap_values=shap_values)

    output_csv = "data/processed/fraud_model_processed.csv"
    os.makedirs(os.path.dirname(output_csv), exist_ok=True)
    df_final.to_csv(output_csv, index=False)
    print(f"Final explained dataset saved at: {output_csv}")
